<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
  </head>
  <body>
    <!-- Decap CMS UI -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
    <script>
      // Automatische Slug-ID-Erzeugung für Projekte
      function mirlSlugifyId(input) {
        if (!input) return '';
        return String(input)
          .toLowerCase()
          .trim()
          // Umlaute/Diakritika entfernen
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          // Alles, was kein a–z oder 0–9 ist, durch Bindestrich ersetzen
          .replace(/[^a-z0-9]+/g, '-')
          // Führende / doppelte / endende Bindestriche aufräumen
          .replace(/^-+|-+$/g, '');
      }

      const DEFAULT_LICENSE = {
        key: 'License',
        value: 'MIT • CC BY-NC-SA',
        url: '#license'
      };

      const STATUS_LABELS = {
        released: 'Released',
        draft: 'Draft',
        beta: 'Beta',
        wip: 'WIP',
        planned: 'Planned'
      };

      const DEFAULT_VALUES = {
        datapack: {
          game: 'Minecraft Java',
          type: 'Datapack'
        },
        printing: {
          projectType: '3D print'
        }
      };

      function normaliseText(value) {
        return typeof value === 'string' ? value.trim() : '';
      }

      function formatStatusLabel(value) {
        const key = normaliseText(value).toLowerCase();
        if (!key) return '';
        return STATUS_LABELS[key] || (key.charAt(0).toUpperCase() + key.slice(1));
      }

      function mergeCustomInfoItems(autoItems, modalContent) {
        if (!modalContent || typeof modalContent.get !== 'function') return autoItems;
        const existing = modalContent.get('infoItems');
        if (!existing || typeof existing.forEach !== 'function') return autoItems;
        const keys = new Set(autoItems.map((item) => item.key.toLowerCase()));
        existing.forEach((entry) => {
          const key = normaliseText(entry && entry.get ? entry.get('key') : entry.key);
          const value = normaliseText(entry && entry.get ? entry.get('value') : entry.value);
          if (!key || !value || keys.has(key.toLowerCase())) return;
          const url = normaliseText(entry && entry.get ? entry.get('url') : entry.url);
          const newTab = !!(entry && entry.get ? entry.get('newTab') : entry.newTab);
          autoItems.push({ key, value, url, newTab });
          keys.add(key.toLowerCase());
        });
        return autoItems;
      }

      function buildInfoItems(project) {
        if (!project) return [];
        const typeRaw = normaliseText(project.get && project.get('type'));
        const type = typeRaw === 'printing' ? 'printing' : 'datapack';
        const modalContent = project.get && project.get('modalContent');
        const mcVersion = normaliseText(project.get && project.get('mcVersion'));
        const statusLabel = formatStatusLabel(project.get && project.get('status'));
        const requires = normaliseText(project.get && project.get('requires'));
        const printer = normaliseText(project.get && project.get('printer'));
        const material = normaliseText(project.get && project.get('material'));

        const items = [];
        if (type === 'datapack') {
          items.push({ key: 'Game', value: DEFAULT_VALUES.datapack.game });
          items.push({ key: 'Type', value: DEFAULT_VALUES.datapack.type });
          if (statusLabel) items.push({ key: 'Status', value: statusLabel });
          items.push({ key: 'Minecraft', value: mcVersion });
          items.push({ key: 'Requires', value: requires });
        } else {
          items.push({ key: 'Project type', value: DEFAULT_VALUES.printing.projectType });
          items.push({ key: 'Printer', value: printer });
          items.push({ key: 'Material', value: material });
          if (statusLabel) items.push({ key: 'Status', value: statusLabel });
        }
        items.push({ ...DEFAULT_LICENSE });

        return mergeCustomInfoItems(items, modalContent);
      }

      if (window.CMS) {
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            if (!entry) return;
            const slug = entry.get('slug');
            // Nur auf die projects.json-Datei anwenden
            if (slug !== 'projects') {
              return;
            }
            const data = entry.get('data');
            if (!data || !data.get('projects')) {
              return;
            }
            const projects = data.get('projects');
            if (!projects || typeof projects.map !== 'function') {
              return;
            }
            const updated = projects.map((project) => {
              if (!project) return project;
              const titleRaw = project.get('title');
              const idRaw = project.get('id');
              const title = titleRaw == null ? '' : String(titleRaw);
              const currentId = idRaw == null ? '' : String(idRaw).trim();
              const modalInfoItems = buildInfoItems(project);

              let nextProject = project;
              // Bestehende IDs nicht überschreiben, nur leere füllen
              if (!currentId && title) {
                const slugified = mirlSlugifyId(title) || 'projekt';
                nextProject = nextProject.set('id', slugified);
              }

              if (modalInfoItems.length) {
                nextProject = nextProject.setIn(['modalContent', 'infoItems'], modalInfoItems);
              }
              return nextProject;
            });
            return data.set('projects', updated);
          }
        });
      }
    </script>

  </body>
</html>
